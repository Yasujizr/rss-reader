// Copyright 2014 Josh Froelich. All rights reserved.
// Use of this source code is governed by a MIT-style license
// that can be found in the LICENSE file

'use strict';

var lucu = lucu || {};
lucu.feed = lucu.feed || {};

/**
 * TODO: lucu.feed.add no longer sends message when complete so the caller
 * needs to do this.
 * chrome.runtime.sendMessage({type:'subscribe',feed:feed});
 */
lucu.feed.add = function(db, feed, oncomplete, onerror) {

  var cleanedFeed = lucu.feed.sanitize(feed);

  var storableFeed = {};
  storableFeed.url = feed.url;
  storableFeed.schemeless = lucu.uri.filterScheme(storableFeed.url);

  // TODO: title must be somehow defined or else it wont be returned
  // when sorting by title in forAllFeeds in the options page. This is
  // kind of ugly and should eventually be improved.

  if(cleanedFeed.title) {
    storableFeed.title = cleanedFeed.title;
  } else {
    storableFeed.title = '';
  }

  if(cleanedFeed.description) {
    storableFeed.description = cleanedFeed.description;
  }

  if(cleanedFeed.link) {
    storableFeed.link =  cleanedFeed.link;
  }

  if(cleanedFeed.date) {
    storableFeed.date = cleanedFeed.date;
  }

  // The fetched date might not be set when importing feeds from
  // an OPML file or when subscribing to a feed while offline
  if(feed.fetched) {
    storableFeed.fetched = feed.fetched;
  }

  storableFeed.created = Date.now();

  // This is expected to trigger onerror when adding a feed
  // where schemeless is not unique because of the unique flag
  // on feedStore.schemelessIndex

  var addFeedTransaction = db.transaction('feed','readwrite');
  var feedStore = addFeedTransaction.objectStore('feed');
  var addFeedRequest = feedStore.add(storableFeed);
  addFeedRequest.onerror = onerror;
  addFeedRequest.onsuccess = lucu.feed.onAddSuccess.bind(addFeedRequest,
    db, storableFeed, feed.entries, oncomplete);
};

lucu.feed.onAddSuccess = function(db, storableFeed, entries, onComplete) {
  // NOTE: expects this instanceof IDBRequest

  // Update using the id generated by indexedDB
  storableFeed.id = this.result;

  // Handoff to mergeAll to insert the entries for the feed, if there are any.
  // mergeAll has its own logic of dealing with no entries and will later handoff
  // to onComplete
  lucu.entry.mergeAll(db, storableFeed, entries, onComplete);
};
